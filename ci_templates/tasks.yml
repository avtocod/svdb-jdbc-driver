.sdevtool_install: &sdevtool_install
  wget -q -O - $NEXUS_HOST/repository/bin/sdevtool/install-ci.sh | /bin/sh

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - if: $CI_COMMIT_BRANCH

check-ci:
  image: dp.spectrumdata.tech/alpine/git
  stage: check
  only: ['dev']
  script:
    - *sdevtool_install
    - echo "DEPLOY_VERSION=$(cat gradle.properties | cut -d "=" -f 2 | tr -d " " | head -n 1)" >> build.env
    - ~/sdevtool build check-ci --no-check-version
  artifacts:
    when: on_failure
    reports:
      dotenv: build.env

check-ci-branch:
  image: dp.spectrumdata.tech/alpine/git
  # чтобы не отменала go-test, go-build из другой фазы
  stage: test
  except: ['master','dev']
  script:
    - *sdevtool_install
    - echo "DEPLOY_VERSION=$(cat gradle.properties | cut -d "=" -f 2 | tr -d " " | head -n 1)" >> build.env
    - ~/sdevtool build check-ci --no-check-version
  artifacts:
    reports:
      dotenv: build.env

kt-test:
  image: $KT_IMAGE
  stage: test
  before_script:
    - ./test-instance/svdb-srv --demo-mode &
  script:
    - ./gradlew test
